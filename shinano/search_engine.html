<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信濃サーチ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho+B1:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        #logo-container {
            font-family: 'Shippori Mincho B1', serif;
        }
        .search-card {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease-in-out;
        }
        .search-card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .news-card {
             box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .pagination a, .pagination span {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 4px;
            border-radius: 9999px;
            color: #4285f4;
            text-decoration: none;
        }
        .pagination a:hover {
            background-color: #f1f3f4;
        }
        .pagination span {
            color: #202124;
            font-weight: bold;
        }
        .intermittent-glitch { 
            position: relative; 
        }
        .intermittent-glitch span { 
            position: relative; 
            z-index: 2; 
        }
        .intermittent-glitch::before, 
        .intermittent-glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            overflow: hidden;
            z-index: 1;
        }
        .intermittent-glitch::before { 
            left: 2px; 
            text-shadow: -2px 0 #ff00c1; 
            animation: intermittent-glitch-anim-1 7s infinite steps(1); 
        }
        .intermittent-glitch::after { 
            left: -2px; 
            text-shadow: -2px 0 #00fff9; 
            animation: intermittent-glitch-anim-2 7s infinite steps(1); 
        }
        @keyframes intermittent-glitch-anim-1 {
            0%, 99% { clip-path: polygon(0 0, 0 0, 0 0, 0 0); }
            99.1% { clip-path: inset(15% 0 86% 0); }
            99.3% { clip-path: inset(4% 0 46% 0); }
            99.5% { clip-path: inset(75% 0 23% 0); }
            99.7% { clip-path: inset(32% 0 33% 0); }
            99.9% { clip-path: inset(92% 0 3% 0); }
            100% { clip-path: polygon(0 0, 0 0, 0 0, 0 0); }
        }
        @keyframes intermittent-glitch-anim-2 {
            0%, 99% { clip-path: polygon(0 0, 0 0, 0 0, 0 0); }
            99.2% { clip-path: inset(78% 0 2% 0); }
            99.4% { clip-path: inset(23% 0 12% 0); }
            99.6% { clip-path: inset(83% 0 6% 0); }
            99.8% { clip-path: inset(36% 0 51% 0); }
            100% { clip-path: polygon(0 0, 0 0, 0 0, 0 0); }
        }
    </style>
</head>
<body class="bg-white text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        
        <header class="flex flex-col items-center justify-center pt-16 md:pt-24 mb-8 transition-all duration-300" id="header">
            <h1 id="logo-container" class="text-6xl text-gray-800 intermittent-glitch" data-text="信濃サーチ">
                <span>信濃サーチ</span>
            </h1>
            <form id="search-form" class="w-full max-w-2xl mt-8">
                <div class="relative">
                    <input 
                        type="search" 
                        id="search-input" 
                        class="w-full p-4 pr-12 text-gray-900 border border-gray-300 rounded-full bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none shadow-sm hover:shadow-md transition-shadow" 
                        placeholder="長野県の情報を検索"
                    >
                    <button type="submit" class="absolute top-0 right-0 h-full p-4 text-gray-500 hover:text-blue-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                </div>
            </form>
        </header>

        <main id="content-area">
            <!-- Content will be rendered here by JavaScript -->
        </main>

        <footer class="text-center text-gray-500 mt-12 text-sm">
            <p>&copy; 2024 Shinano Search. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // --- データ管理 ---
        const fallbackSearchData = {
            "config": {
                "base_url": ""
            },
            "specific": [
                {
                    "keywords": ["佐倉具親"],
                    "matchCount": 1,
                    "results": [
                        {
                            "title": "【代替データ】郷土史研究家、佐倉具親氏の功績",
                            "url": "#/history/sakura-gushin-01",
                            "description": "長野県の郷土史研究の第一人者である佐倉具親氏。彼の残した数々の文献は、今なお地域の歴史を解き明かす鍵となっている..."
                        }
                    ]
                }
            ],
            "generic_pool": [
                {
                    "title": "【代替データ】長野県公式観光サイト - Go NAGANO",
                    "url": "#/official/go-nagano",
                    "description": "さわやかな空気と豊かな自然、あたたかな人情に出会える場所、信州へ。長野県の公式観光ウェブサイトです。"
                }
            ]
        };

        const topPageContent = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">地域のニュース</h2>
                    <div class="space-y-4">
                        <div class="p-4 bg-white rounded-lg news-card">
                            <h3 class="font-bold text-blue-700">上田城跡公園で千本桜まつり開催へ</h3>
                            <p class="text-sm text-gray-600 mt-1">春の訪れを告げる恒例のイベント。期間中は夜間のライトアップも予定されている。</p>
                        </div>
                        <div class="p-4 bg-white rounded-lg news-card">
                            <h3 class="font-bold text-blue-700">県内スキー場、今シーズンの営業を終了</h3>
                            <p class="text-sm text-gray-600 mt-1">記録的な暖冬の影響を受けつつも、多くのスキーヤーで賑わったシーズンが幕を閉じた。</p>
                        </div>
                         <div class="p-4 bg-white rounded-lg news-card">
                            <h3 class="font-bold text-blue-700">松本市美術館で草間彌生展、来場者10万人突破</h3>
                            <p class="text-sm text-gray-600 mt-1">世界的な前衛芸術家、草間彌生の作品展が人気を博している。展示は来月末まで。</p>
                        </div>
                    </div>
                </div>
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">天気情報</h2>
                    <div class="p-4 bg-white rounded-lg news-card">
                        <h3 class="font-bold">長野市</h3>
                        <p class="text-2xl mt-2">15℃ ☀️</p>
                        <p class="text-sm text-gray-600">晴れ時々曇り</p>
                        <p class="text-sm text-gray-600 mt-2">降水確率: 10%</p>
                    </div>
                </div>
            </div>
        `;

        // --- アプリケーションロジック ---
        let searchDB = null;
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const contentArea = document.getElementById('content-area');
        const header = document.getElementById('header');
        const logo = document.getElementById('logo-container');

        const loadSearchData = async () => {
             const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('test_fallback')) {
                console.warn('テストモード: 代替データを強制的に読み込みました。');
                return fallbackSearchData;
            }
            try {
                const response = await fetch('search-data.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return await response.json();
            } catch (error) {
                console.warn('警告: search-data.jsonが見つかりませんでした。代替データを読み込みます。');
                return fallbackSearchData;
            }
        };

        const getDeterministicHash = (str) => {
            let hash = 0;
            if (str.length === 0) return hash;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return Math.abs(hash);
        };

        const renderResults = (results, query, delay) => {
            contentArea.innerHTML = '';
            header.classList.remove('pt-16', 'md:pt-24');
            header.classList.add('pt-4', 'md:pt-6');
            logo.classList.remove('text-6xl');
            logo.classList.add('text-4xl');
            searchForm.classList.remove('mt-8');
            searchForm.classList.add('mt-6');

            if (results && results.length > 0) {
                const hash = getDeterministicHash(query);
                const resultCount = (hash % 28001) + 2000;
                const searchTime = (delay / 1000).toFixed(2);
                const stats = `<p class="text-sm text-gray-500 mb-4">約 ${resultCount.toLocaleString()} 件 （${searchTime} 秒）</p>`;
                const pagination = `
                    <div class="mt-10 text-center pagination">
                        <span>1</span>
                        <a href="#">2</a>
                        <a href="#">3</a>
                        <a href="#">4</a>
                        <a href="#">5</a>
                        <a href="#">次へ</a>
                    </div>
                `;
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'space-y-6';

                const baseUrl = searchDB.config?.base_url || '';

                results.forEach(item => {
                    const finalUrl = item.url.startsWith('http') ? item.url : baseUrl + item.url;
                    const card = `
                        <div class="bg-white p-6 rounded-lg search-card">
                            <a href="${finalUrl}" target="_blank" rel="noopener noreferrer" class="block">
                                <h3 class="text-xl font-semibold text-blue-700 hover:underline">${item.title}</h3>
                                <p class="text-sm text-green-700 mt-1">${finalUrl}</p>
                                <p class="text-gray-600 mt-2">${item.description}</p>
                            </a>
                        </div>
                    `;
                    resultsContainer.innerHTML += card;
                });
                
                contentArea.innerHTML = stats;
                contentArea.appendChild(resultsContainer);
                contentArea.innerHTML += pagination;
            } else {
                contentArea.innerHTML = `<p class="text-center text-gray-500">検索結果が見つかりませんでした。</p>`;
            }
        };

        const renderTopPage = () => {
            contentArea.innerHTML = topPageContent;
            header.classList.add('pt-16', 'md:pt-24');
            header.classList.remove('pt-4', 'md:pt-6');
            logo.classList.add('text-6xl');
            logo.classList.remove('text-4xl');
            searchForm.classList.add('mt-8');
            searchForm.classList.remove('mt-6');
        };

        const performSearch = (query) => {
            const lowerCaseQuery = query.toLowerCase().trim().split(/\s+/);
            if (lowerCaseQuery.length === 0 || lowerCaseQuery[0] === "") return null;

            let allMatchedResults = [];
            
            searchDB.specific.forEach(entry => {
                const matchedKeywordsCount = entry.keywords.filter(kw => 
                    lowerCaseQuery.some(qKw => qKw.includes(kw.toLowerCase()) || kw.toLowerCase().includes(qKw))
                ).length;
                
                if (matchedKeywordsCount >= entry.matchCount) {
                     allMatchedResults.push(...entry.results);
                }
            });

            if (allMatchedResults.length > 0) {
                const uniqueResults = allMatchedResults.filter((result, index, self) =>
                    index === self.findIndex((r) => r.url === result.url)
                );
                return uniqueResults;
            }

            // Generic search results logic
            if (searchDB.generic_pool && searchDB.generic_pool.length > 0) {
                // Deterministic shuffling based on the query
                const shuffled = [...searchDB.generic_pool].sort((a, b) => {
                    const hashA = getDeterministicHash(a.title + query);
                    const hashB = getDeterministicHash(b.title + query);
                    return hashA - hashB;
                });
                
                return shuffled.slice(0, 10);
            }

            return [];
        };

        const handleSearchSubmit = (event) => {
            event.preventDefault();
            const query = searchInput.value;
            if (!query.trim()) return;

            contentArea.innerHTML = `<p class="text-center text-gray-500">検索中...</p>`;
            header.classList.remove('pt-16', 'md:pt-24');
            header.classList.add('pt-4', 'md:pt-6');
            logo.classList.remove('text-6xl');
            logo.classList.add('text-4xl');
            searchForm.classList.remove('mt-8');
            searchForm.classList.add('mt-6');

            const delay = Math.random() * 200 + 200;

            setTimeout(() => {
                const results = performSearch(query);
                renderResults(results, query, delay);
            }, delay);
        };
        
        const initializePage = async () => {
            searchDB = await loadSearchData();
            
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');

            if (query) {
                searchInput.value = query;
                handleSearchSubmit(new Event('submit'));
            } else {
                renderTopPage();
            }
        };

        searchForm.addEventListener('submit', handleSearchSubmit);
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
